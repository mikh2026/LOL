# Исправление проблем с виджетом фильтра WooCommerce

## Описание проблем

Виджет фильтра WooCommerce может не работать по двум основным причинам:

### 1. Content Security Policy (CSP) блокирует Web Worker'ы
**Ошибка:** `Refused to create a worker from 'blob:...' because it violates the following Content Security Policy directive`

**Причина:** CSP не разрешает создание Web Worker'ов из blob URL'ов, которые использует WooCommerce Blocks.

### 2. WooCommerce REST API недоступен
**Ошибка:** `There is no route for the given namespace (/wc/store/v1) in the store`

**Причина:** WooCommerce REST API не настроен или недоступен.

## Решение

### Автоматическое исправление

В файл `functions.php` добавлен код, который автоматически исправляет эти проблемы:

1. **CSP заголовки** - добавляет директиву `worker-src` для разрешения Web Worker'ов
2. **REST API** - проверяет и исправляет настройки WooCommerce
3. **Постоянные ссылки** - автоматически настраивает структуру ссылок
4. **CORS** - добавляет поддержку CORS для REST API

### Ручное исправление

Если автоматическое исправление не помогло, выполните следующие шаги:

#### Шаг 1: Проверьте настройки постоянных ссылок

1. Перейдите в **Админка → Настройки → Постоянные ссылки**
2. Выберите любой вариант кроме "Обычные" (рекомендуется "Название записи")
3. Нажмите "Сохранить изменения"

#### Шаг 2: Убедитесь, что WooCommerce REST API включен

1. Перейдите в **WooCommerce → Настройки → Дополнительно**
2. В разделе "REST API" убедитесь, что API включен
3. Если нет, включите его

#### Шаг 3: Установите WooCommerce Blocks

1. Перейдите в **Плагины → Добавить новый**
2. Найдите "WooCommerce Blocks"
3. Установите и активируйте плагин

#### Шаг 4: Проверьте настройки сервера

Убедитесь, что ваш сервер поддерживает:
- `.htaccess` файлы (для Apache)
- `mod_rewrite` модуль (для Apache)
- Правильные права доступа к файлам

### Диагностика

Для диагностики проблем используйте файл `woocommerce-debug.php`:

1. Скопируйте файл в папку вашей темы
2. Добавьте в `functions.php` строку: `require_once get_template_directory() . '/woocommerce-debug.php';`
3. Перейдите в **Инструменты → WC Debug** в админке

### Проверка работы

После внесения изменений:

1. Очистите кэш сайта (если используется)
2. Обновите страницу магазина
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь, что фильтры загружаются без ошибок

### Дополнительные настройки

#### Для Nginx

Если используете Nginx, добавьте в конфигурацию:

```nginx
location / {
    try_files $uri $uri/ /index.php?$args;
}
```

#### Для Apache

Убедитесь, что в `.htaccess` есть:

```apache
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
```

## Часто задаваемые вопросы

### Q: Фильтры все еще не работают после исправления
**A:** Проверьте консоль браузера на наличие JavaScript ошибок. Возможно, проблема в конфликте с другими плагинами.

### Q: Как проверить, что CSP исправлен?
**A:** Откройте инструменты разработчика → Network → проверьте заголовки ответа на наличие `Content-Security-Policy` с `worker-src`.

### Q: Нужно ли перезапускать сервер?
**A:** Нет, изменения в `functions.php` применяются автоматически. Достаточно обновить страницу.

### Q: Может ли это повлиять на безопасность?
**A:** Добавленные CSP директивы безопасны и разрешают только необходимые ресурсы для работы WooCommerce Blocks.

## Поддержка

Если проблемы остаются, проверьте:
1. Логи ошибок сервера
2. Консоль браузера
3. Сетевые запросы в инструментах разработчика
4. Совместимость версий WordPress, WooCommerce и темы