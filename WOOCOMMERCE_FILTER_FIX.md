# Исправление проблемы с фильтром WooCommerce

## Проблема
Фильтр WooCommerce перестал работать после внесения изменений в функции уведомлений.

## Причины
1. Функция `clear_woocommerce_notices()` вызывалась на хуке `woocommerce_before_shop_loop` с приоритетом 5
2. Это мешало правильной инициализации фильтров WooCommerce
3. Функция очищала уведомления, которые могли быть важны для работы фильтра

## Внесенные исправления

### 1. Убран проблемный хук
```php
// Убрано:
// add_action('woocommerce_before_shop_loop', 'clear_woocommerce_notices', 5);

// Оставлено:
add_action('woocommerce_before_single_product_summary', 'clear_woocommerce_notices', 5);
add_action('wp_loaded', 'clear_woocommerce_notices');
```

### 2. Улучшена функция clear_woocommerce_notices
Добавлена проверка на страницы с фильтрами:
```php
// Не очищаем уведомления на страницах с фильтрами WooCommerce
if (is_shop() || is_product_category() || is_product_tag() || is_tax('product_cat') || is_tax('product_tag')) {
    // На страницах магазина и категорий оставляем уведомления, связанные с фильтрацией
    return;
}
```

### 3. Добавлены функции диагностики
- `debug_woocommerce_filter()` - логирует информацию о запросах WooCommerce
- `check_woocommerce_filter_status()` - проверяет состояние основных компонентов
- `restore_woocommerce_filter_behavior()` - восстанавливает стандартное поведение
- `check_woocommerce_widgets()` - проверяет активность стандартных виджетов

## Диагностика

### Проверка логов
После внесения изменений проверьте логи WordPress на наличие сообщений:
- `=== WOOCOMMERCE FILTER DEBUG ===`
- `WooCommerce main query is active`
- `WooCommerce layered navigation widget is not active`

### Проверка виджетов
Убедитесь, что в админ-панели WordPress > Внешний вид > Виджеты активны:
- WooCommerce: Фильтр по атрибутам
- WooCommerce: Фильтр по цене
- WooCommerce: Категории товаров
- WooCommerce: Облако тегов товаров

### Проверка настроек
В админ-панели WordPress > WooCommerce > Настройки > Товары:
- Убедитесь, что включена опция "Включить фильтрацию товаров"
- Проверьте настройки "Сортировка по умолчанию"

## Дополнительные шаги

### 1. Очистка кеша
Если используете плагины кеширования:
- Очистите кеш страниц
- Очистите кеш объектов
- Очистите кеш базы данных

### 2. Проверка конфликтов
Отключите временно другие плагины и проверьте, не конфликтуют ли они с WooCommerce

### 3. Проверка темы
Убедитесь, что тема поддерживает WooCommerce и не переопределяет стандартные шаблоны

## Тестирование

### 1. Проверьте работу фильтра по цене
- Перейдите на страницу магазина
- Используйте слайдер цен
- Убедитесь, что товары фильтруются корректно

### 2. Проверьте фильтр по категориям
- Выберите категорию товаров
- Убедитесь, что отображаются только товары из выбранной категории

### 3. Проверьте фильтр по атрибутам
- Если настроены атрибуты товаров, проверьте их работу
- Убедитесь, что фильтрация по атрибутам работает

## Если проблема не решена

### 1. Проверьте консоль браузера
Откройте Developer Tools (F12) и проверьте наличие JavaScript ошибок

### 2. Проверьте Network вкладку
Убедитесь, что AJAX запросы фильтрации отправляются и получают ответы

### 3. Включите режим отладки WordPress
В `wp-config.php`:
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);
```

### 4. Проверьте права доступа
Убедитесь, что файлы WooCommerce имеют правильные права доступа

## Контакты для поддержки
Если проблема не решена, обратитесь к разработчику темы или плагина WooCommerce.